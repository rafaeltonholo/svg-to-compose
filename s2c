#!/bin/bash
DEBUG=false
VERBOSE=false
PLATFORM_WINDOWS="mingwX64"
PLATFORM_LINUX="linux86"
PLATFORM_MAC_OS="macosX64"
PLATFORM_MAC_M1="macosArm64"

if [[ "$*" == *"--debug"* ]]; then
  DEBUG=true
fi

if [[ "$*" == *"--verbose"* ]]; then
  DEBUG=true
  VERBOSE=true
fi

fn_print_debug() {
  if [[ $DEBUG == true ]]; then
    echo "D: $1"
  fi
}

fn_print_verbose() {
  if [[ $VERBOSE == true ]]; then
    echo "V: $1"
  fi
}

fn_print_error() {
  echo "E: $1"
}

fn_os_check() {
  unameOut=$(uname -a)
  case "${unameOut}" in
      *Microsoft*)  PLATFORM=$PLATFORM_WINDOWS;; # must be first since Windows subsystem for linux will have Linux in the name too
      *microsoft*)  PLATFORM=$PLATFORM_WINDOWS;; #WARNING: My v2 uses ubuntu 20.4 at the moment slightly different name may not always work
      Linux*)       PLATFORM=$PLATFORM_LINUX;;
      Darwin*)      PLATFORM=$PLATFORM_MAC_OS;;
      CYGWIN*)      PLATFORM=$PLATFORM_WINDOWS;;
      MINGW*)       PLATFORM=$PLATFORM_WINDOWS;;
      *Msys)        PLATFORM=$PLATFORM_WINDOWS;;
      *)            PLATFORM="UNKNOWN:${unameOut}"
  esac

  if [[ ${PLATFORM} == $PLATFORM_MAC_OS ]] && sysctl -n machdep.cpu.brand_string | grep -q 'Apple M1'; then
      PLATFORM=$PLATFORM_MAC_M1
  fi
}

fn_main() {
  fn_print_verbose "Initializing SVG to Compose script"
  fn_print_verbose "Verifying binaries"

  bin_folder="bin"
  must_download=false
  if [[ ! -d "$bin_folder" ]]; then
    fn_print_verbose "Bin folder not present. Checking if it is the project folder..."

    fn_os_check

    fn_print_verbose "Checking release version for $PLATFORM"
    bin_folder="shared/build/bin/$PLATFORM/releaseExecutable"
    if [[ ! -d "$bin_folder" ]]; then
      fn_print_verbose "Checking debug version for $PLATFORM"
      bin_folder="shared/build/bin/$PLATFORM/debugExecutable"
      if [[ ! -d "$bin_folder" ]]; then
        must_download=true
      fi
    fi
  fi

  if [[ $must_download == true ]]; then
    fn_print_debug "Downloading binaries from Github"
    # TODO.
  else
    program_ext="kexe"

    if [[ $PATFORM == $PLATFORM_WINDOWS ]]; then
        program_ext="exe"
    fi

    command $bin_folder/s2c.$program_ext "$@"
  fi
}

fn_main "$@"
