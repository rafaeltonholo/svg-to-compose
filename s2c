#!/bin/bash
DEBUG=false
VERBOSE=false

if [[ "$*" == *"--debug"* ]]; then
  DEBUG=true
fi

if [[ "$*" == *"--verbose"* ]]; then
  DEBUG=true
  VERBOSE=true
fi

fn_print_debug() {
  if [[ $DEBUG == true ]]; then
    echo "D: $1"
  fi
}

fn_print_verbose() {
  if [[ $VERBOSE == true ]]; then
    echo "V: $1"
  fi
}

fn_print_error() {
  echo "E: $1"
}

fn_os_check() {
  unameOut=$(uname -a)
  case "${unameOut}" in
      *Microsoft*)  PLATFORM="mingwX64";; # must be first since Windows subsystem for linux will have Linux in the name too
      *microsoft*)  PLATFORM="mingwX64";; #WARNING: My v2 uses ubuntu 20.4 at the moment slightly different name may not always work
      Linux*)       PLATFORM="linux86";;
      Darwin*)      PLATFORM="macosX64";;
      CYGWIN*)      PLATFORM="mingwX64";;
      MINGW*)       PLATFORM="mingwX64";;
      *Msys)        PLATFORM="mingwX64";;
      *)            PLATFORM="UNKNOWN:${unameOut}"
  esac

  if [[ ${PLATFORM} == "macosX64" ]] && sysctl -n machdep.cpu.brand_string | grep -q 'Apple M1'; then
      PLATFORM="macosArm64"
  fi
}

fn_main() {
  fn_print_verbose "Initializing SVG to Compose script"
  fn_print_verbose "Verifying binaries"

  bin_folder="bin"
  must_download=false
  if [[ ! -d "$bin_folder" ]]; then
    fn_print_verbose "Bin folder not present. Checking if it is the project folder..."

    fn_os_check

    fn_print_verbose "Checking release version for $PLATFORM"
    bin_folder="shared/build/bin/$PLATFORM/releaseExecutable"
    if [[ ! -d "$bin_folder" ]]; then
      fn_print_verbose "Checking debug version for $PLATFORM"
      bin_folder="shared/build/bin/$PLATFORM/debugExecutable"
      if [[ ! -d "$bin_folder" ]]; then
        must_download=true
      fi
    fi
  fi

  if [[ $must_download == true ]]; then
    fn_print_debug "Downloading binaries from Github"
  else
    $bin_folder/s2c.exe "$@"
  fi
}

fn_main "$@"
